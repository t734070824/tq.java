

2019-05-14

## 数据库拆分
1. 通过某种条件, 按照某个维度, 将存放在同一个数据库中的数据分散到多个数据库(主机), 达到分散单库负载的效果

### 垂直拆分
1. **专库专用**
    - 按照业务将表进行分类, 分布到不同的数据库中 --> 将压力分布到不同的库上
2. 优点
    - 拆分后业务清晰, 拆分规则明确
    - 系统之间整合或扩展容易
    - 数据维护简单
3. 缺点
    - join, 提高了复杂度
    - 每种业务不同造成部分数据库的压力过高, 影响整体性能
    - 事务处理复杂
    

### 水平拆分
1. 垂直拆分遇到单机瓶颈 可以 水平拆分
    - 将 同一个数据表 拆分 到不同的数据库中
2. 可以理解为 **按照数据行拆分**
    - 分表
    - 分库
3. 优点
    - 不存在单库大数据, 提高并发能力
    - 对应用透明
    - 按照合理的规则拆分, join避免跨库
    - 提高系统稳定性以及负载
4. 缺点
    - **拆分规则难以抽象**
    - 分片事务一致性难以解决
    - 跨库 join

### 垂直拆分 vs 水平拆分
1. 共同缺点
    - 引入分布式事务问题
    - 跨节点 join 问题
    - 跨节点合并 分页 问题

### 数据源管理
1. 客户端模式: 自己 配置管理, 直接访问数据库
    - 简单, 性能损耗小
    - 不够通用, 业务不透明, 处理复杂
2. 中间代理层, 统一管理数据源, 对前端透明
    - 通用, 透明, 修改少
    - 难度大, 二次转发

### 拆分原则
1. 尽量不拆分
2. 减少join 数据冗余 分组
3. 尽量避免分布式事务

### 切分方案
1. 范围, 枚举, 时间, 取模, 哈希, 指定

### 案例分析
1. 建立一个历史his系统，将公司的一些历史个人游戏数据保存到这个his系统中，主要是写入，还有部分查询，读写比约为1:4；由于是所有数据的历史存取，所以并发要求比较高； 
    - 分析：
    - 历史数据
    - 写多都少
    - 越近日期查询越频繁？
    - 什么业务数据？用户游戏数据
    - 有没有大规模分析查询？
    - 数据量多大？
    - 保留多久？
    - 机器资源有多少？
   
   - 方案1：按照日期每月一个分片
   - 带来的问题：1.数据热点问题（压力不均匀）
   - 方案2：按照用户取模，  --by Jerome 就这个比较合适了
   - 带来的问题：后续扩容困难
   - 方案3：按用户ID范围分片（1-1000万=分片1，xxx）
   - 带来的问题：用户活跃度无法掌握，可能存在热点问题

    
   